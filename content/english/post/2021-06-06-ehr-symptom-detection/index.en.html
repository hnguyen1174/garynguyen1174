---
title: "EHR Symptom Detection"
summary: In this project, I used deep learning to identify symptoms in electronic health records.
author: Gary Nguyen
date: '2021-06-06'
output:
  blogdown::html_page:
    highlight: tango
    toc: true
slug: []
thumbnail: "images/nyc_healthcare.jpeg"
categories:
  - Project
tags:
  - NLP
  - R
  - classification
Description: ''
Categories: []
DisableComments: no
---

<script src="{{< blogdown/postref >}}index.en_files/header-attrs/header-attrs.js"></script>

<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-dataset">The Dataset</a></li>
<li><a href="#method">Method</a></li>
<li><a href="#results">Results:</a></li>
<li><a href="#future-extensions">Future Extensions</a></li>
<li><a href="#understanding-symptoms">Understanding Symptoms</a></li>
<li><a href="#artifact">Artifact</a></li>
</ul>
</div>

<p><a href="https://github.com/hnguyen1174/ehr-symptom-detection"><img src="https://img.shields.io/badge/GitHub-View_on_GitHub-blue?logo=GitHub" alt="GitHub" /></a></p>
<p>Technologies:</p>
<ul>
<li>Python (<code>transformers</code> and <code>transformers_interpret</code>) for BERT model building</li>
<li>Streamlit (<code>streamlit</code>) for application</li>
<li>R (<code>tidyverse</code>, <code>keras</code>) for data cleaning, visualization and CNN/RNN model building</li>
<li>R-Shiny (<code>shiny</code>) for visualizing the training progresses and NimbleMiner for training set building</li>
</ul>
<div id="introduction" class="section level3">
<h3>Introduction</h3>
<div id="overview" class="section level4">
<h4>Overview</h4>
<p>In this project, I investigated whether using deep learning models on a medical records corpus of notes will result in better predictive performance compared to traditional machine learning methods. I used a collection of deidentified patient’s discharge notes that have been annotated for 11 symptoms: dyspnea (shortness of breath), chest pain, nausea, fatigue, cough, dizziness, weight change, palpitation, confusion, peripheral edema and anorexia.</p>
<p>I compared the performance (accuracy) between two machine learning models (logistic regression and random forest) as baseline models, with multiple NLP deep learning models. I found BERT with two additional layers of CNN and LSTM added significant benefits over the baseline models.</p>
<p>Using a deep learning model to detect symptoms from medical notes can save time and resources during outpatient visits. A clinician or nurse can quickly pinpoint which symptoms the patient has, compare with symptoms in the past and come up with more accurate and efficient treatment plan.</p>
</div>
<div id="challenges" class="section level4">
<h4>Challenges</h4>
<p>There are many challenges that are associated with natural language processing in healthcare. Previous studies have shown that the traditional machine learning methods’ inability to effectively model the subtleties of the medical sublanguage hinder performance. In addition, traditional NLP methods can work with synonyms but not similar terms, so many of them suffer from the curse of dimensionality. In the face of such challenges, advanced methods in natural language processing such as CNN, LSTM and BERT are gaining popularity thanks to their ability to capture and model contexts in long text sequences.</p>
</div>
</div>
<div id="the-dataset" class="section level3">
<h3>The Dataset</h3>
<p>The project used a dataset of discharge notes for patients with heart diseases. The training dataset has 8,031 notes, and the test dataset has 293 notes. The test set is a gold-standard, human-labeled dataset while the training set is generated by <a href="https://github.com/hnguyen1174/NimbleMiner">NimberMiner</a>. There are eleven symptoms in the datasets. They all have class imbalances: the negative class outnumbers the positive class across symptoms. Some deep learning models that I used, such as BERT, address the issue of class imbalance better than others do. The class imbalance is presented as follows:</p>
<table>
<thead>
<tr class="header">
<th align="center">Symptom</th>
<th align="center">Training Set</th>
<th align="center">Test Set</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Dyspnea</td>
<td align="center">39%</td>
<td align="center">49%</td>
</tr>
<tr class="even">
<td align="center">Chest Pain</td>
<td align="center">30%</td>
<td align="center">30%</td>
</tr>
<tr class="odd">
<td align="center">Nausea</td>
<td align="center">21%</td>
<td align="center">21%</td>
</tr>
<tr class="even">
<td align="center">Fatigue</td>
<td align="center">18%</td>
<td align="center">23%</td>
</tr>
<tr class="odd">
<td align="center">Cough</td>
<td align="center">16%</td>
<td align="center">21%</td>
</tr>
<tr class="even">
<td align="center">Dizziness</td>
<td align="center">14%</td>
<td align="center">15%</td>
</tr>
<tr class="odd">
<td align="center">Weight Change</td>
<td align="center">10%</td>
<td align="center">9%</td>
</tr>
<tr class="even">
<td align="center">Palpitation</td>
<td align="center">8%</td>
<td align="center">5%</td>
</tr>
<tr class="odd">
<td align="center">Confusion</td>
<td align="center">8%</td>
<td align="center">11%</td>
</tr>
<tr class="even">
<td align="center">Peripheral Edema</td>
<td align="center">7%</td>
<td align="center">11%</td>
</tr>
<tr class="odd">
<td align="center">Anorexia</td>
<td align="center">5%</td>
<td align="center">8%</td>
</tr>
</tbody>
</table>
<p>The notes are in the form of free-text. They do not have strict structure and vary in length based on the symptoms of each patient and their severity. The training set and the test set are relatively similar in terms of length: the maximum length is 4,547 words for the training set and 4,273 words for the test set, and the average length is 1,025 for the training set and 1,336 for the test set.</p>
<p>The notes with symptoms are likely to be longer. This is true across symptoms. An example for cough is shown:</p>
<p align="center">
<img src="sent_density_cough.png" alt="drawing" width="600"/>
</p>
</div>
<div id="method" class="section level3">
<h3>Method</h3>
<div id="baseline-models" class="section level4">
<h4>Baseline Models</h4>
<p>For this project, I chose logistic regression and random forest as the baseline models. Logistic regression and random forest have been used widely as predictive models of choice for text classification. For logistic regression, I transformed the notes into sparse matrices before training the model. For random forest, I also transformed the notes into sparse matrices, and then used the <code>ranger</code> implementation of random forest in the R language, using twenty decision trees and <code>impurity</code> as the importance metrics. Among these two baseline models, random forest has been widely used in natural language processing tasks because it is highly interpretable.</p>
</div>
<div id="deep-learning-model-training" class="section level4">
<h4>Deep Learning Model Training</h4>
<p>Traditional NLP methods, such as the baseline models, are limited by their vocabulary dictionary for predictive tasks and require complex processing steps. In addition, simplistic models such as logistic regression cannot effectively recognize the semantic relationships between words and n-grams. I chose to perform text classification using word embeddings and convoluted neural networks (CNN) because such models don’t have these restrictions.</p>
<p>I experimented with four different architectures: (1) a 1-layer embedding and 4-layer CNN; (2) a 1-layer fastText embedding and 4-layer CNN and (3) 1-layer embedding, 4-layer CNN followed by a 1-layer Bidirectional Long-short Term Memory (LSTM) and (4) a BERT layer, 2-layer CNN and 1-layer LSTM. I trained binary classifications using these 4 architectures for all 11 symptoms. These models are trained using the <code>keras</code> library in R with a <code>tensorflow</code> backend.</p>
</div>
</div>
<div id="results" class="section level3">
<h3>Results:</h3>
<p>I found that deep learning models, on average, produced better performance when compared with traditional machine learning methods. A full accuracy comparison can be found in the table below.</p>
<table style="width:100%;">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="14%" />
<col width="14%" />
<col width="14%" />
<col width="14%" />
<col width="14%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">Symptom</th>
<th align="center">Logistic Regression</th>
<th align="center">Random Forest</th>
<th align="center">4-layer CNN</th>
<th align="center">fastText embeddings + 4-layer CNN</th>
<th align="center">4-layer CNN + Bidirectional LSTM</th>
<th align="center">BERT, 2-layer CNN and LSTM</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Dyspnea</td>
<td align="center">0.19</td>
<td align="center">0.9</td>
<td align="center">0.91</td>
<td align="center">0.89</td>
<td align="center">0.91</td>
<td align="center">0.93</td>
</tr>
<tr class="even">
<td align="center">Chest Pain</td>
<td align="center">0.24</td>
<td align="center">0.79</td>
<td align="center">0.86</td>
<td align="center">0.85</td>
<td align="center">0.86</td>
<td align="center">0.88</td>
</tr>
<tr class="odd">
<td align="center">Nausea</td>
<td align="center">0.19</td>
<td align="center">0.42</td>
<td align="center">0.89</td>
<td align="center">0.83</td>
<td align="center">0.86</td>
<td align="center">0.84</td>
</tr>
<tr class="even">
<td align="center">Fatigue</td>
<td align="center">0.08</td>
<td align="center">0.86</td>
<td align="center">0.85</td>
<td align="center">0.5</td>
<td align="center">0.83</td>
<td align="center">0.88</td>
</tr>
<tr class="odd">
<td align="center">Cough</td>
<td align="center">0.32</td>
<td align="center">0.79</td>
<td align="center">0.81</td>
<td align="center">0.77</td>
<td align="center">0.82</td>
<td align="center">0.84</td>
</tr>
<tr class="even">
<td align="center">Dizziness</td>
<td align="center">0.14</td>
<td align="center">0.8</td>
<td align="center">0.85</td>
<td align="center">0.47</td>
<td align="center">0.77</td>
<td align="center">0.9</td>
</tr>
<tr class="odd">
<td align="center">Weight Change</td>
<td align="center">0.14</td>
<td align="center">0.65</td>
<td align="center">0.7</td>
<td align="center">0.63</td>
<td align="center">0.69</td>
<td align="center">0.85</td>
</tr>
<tr class="even">
<td align="center">Palpitation</td>
<td align="center">0.00</td>
<td align="center">0.56</td>
<td align="center">0.75</td>
<td align="center">0.58</td>
<td align="center">0.62</td>
<td align="center">0.72</td>
</tr>
<tr class="odd">
<td align="center">Confusion</td>
<td align="center">0.21</td>
<td align="center">0.9</td>
<td align="center">0.88</td>
<td align="center">0.3</td>
<td align="center">0.88</td>
<td align="center">0.88</td>
</tr>
<tr class="even">
<td align="center">Peripheral Edema</td>
<td align="center">0.17</td>
<td align="center">0.69</td>
<td align="center">0.64</td>
<td align="center">0.33</td>
<td align="center">0.59</td>
<td align="center">0.8</td>
</tr>
<tr class="odd">
<td align="center">Anorexia</td>
<td align="center">0.00</td>
<td align="center">0.65</td>
<td align="center">0.77</td>
<td align="center">0.34</td>
<td align="center">0.57</td>
<td align="center">0.8</td>
</tr>
</tbody>
</table>
<p>Since deep learning models outperformed the baseline models, below I presented the accuracy and F-score of all 11 symptoms using 4 different deep learning architectures.</p>
<div id="accuracy" class="section level4">
<h4>Accuracy</h4>
<p align="center">
<img src="ehr_chart.png" alt="drawing" width="600"/>
</p>
</div>
<div id="f1-score" class="section level4">
<h4>F1-Score</h4>
<p align="center">
<img src="ehr_chart_f1.png" alt="drawing" width="600"/>
</p>
<p>I also found that the prior of each symptom was important, as the deep learning models had more signals to learn from. The high-prior symptoms (such dyspnea and chest pain) had higher test accuracies.</p>
<table style="width:100%;">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="14%" />
<col width="14%" />
<col width="14%" />
<col width="14%" />
<col width="14%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">Symptom</th>
<th align="center">Logistic Regression</th>
<th align="center">Random Forest</th>
<th align="center">4-layer CNN</th>
<th align="center">fastText embeddings + 4-layer CNN</th>
<th align="center">4-layer CNN + Bidirectional LSTM</th>
<th align="center">BERT, 2-layer CNN and LSTM</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">Prior &gt;15% in training set</td>
<td align="center">20.40%</td>
<td align="center">75.20%</td>
<td align="center">86.40%</td>
<td align="center">76.80%</td>
<td align="center">85.60%</td>
<td align="center">87.40%</td>
</tr>
<tr class="even">
<td align="center">Prior &lt;15% training set</td>
<td align="center">11.00%</td>
<td align="center">70.83%</td>
<td align="center">76.50%</td>
<td align="center">44.17%</td>
<td align="center">68.67%</td>
<td align="center">82.50%</td>
</tr>
<tr class="odd">
<td align="center">Difference</td>
<td align="center">9.40%</td>
<td align="center">4.37%</td>
<td align="center">9.90%</td>
<td align="center">32.63%</td>
<td align="center">16.93%</td>
<td align="center">4.90%</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="future-extensions" class="section level3">
<h3>Future Extensions</h3>
<p>As EHR is becoming ubiquitous and machine learning algorithms for natural language processing are developing very quickly, there are ample opportunities for improvements. There are more features available in the dataset, such as patients’ ages, time and dates of the discharge notes and so on. I can potentially use these features to impose a temporal structure on our data set to not only predict a symptom, but also predict when it will occur in the future.</p>
</div>
<div id="understanding-symptoms" class="section level3">
<h3>Understanding Symptoms</h3>
<div id="streamlit-application" class="section level4">
<h4>Streamlit application</h4>
<p>I also put together a <code>streamlit</code> application that applies the trained BERT model to predict whether a note has any of the five symptoms (dyspnea, chest pain, nausea, fatigue and cough). I will deploy this application when receiving appropriate infrastructure from <code>streamlit</code>.</p>
<p><img src="demo.gif" /></p>
</div>
</div>
<div id="artifact" class="section level3">
<h3>Artifact</h3>
<ul>
<li><a href="https://github.com/hnguyen1174/ehr-symptom-detection">Github</a></li>
<li><a href="https://github.com/hnguyen1174/ehr-symptom-detection/blob/master/reports/Paper%20Draft_V3.pdf">Project report (draft)</a></li>
</ul>
</div>
